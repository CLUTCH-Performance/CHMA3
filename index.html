<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMHA Survey Data AI Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #4c1d95;
            font-size: 28px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header p {
            color: #6b7280;
            font-size: 16px;
        }
        
        .icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
        
        .setup-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .setup-section.hidden {
            display: none;
        }
        
        .setup-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        .setup-item {
            padding: 20px;
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .setup-item.completed {
            border-color: #22c55e;
            background: #f0fdf4;
        }
        
        .setup-item h3 {
            margin-bottom: 15px;
            color: #374151;
        }
        
        .file-input {
            margin: 15px 0;
        }
        
        .file-input input[type="file"] {
            display: none;
        }
        
        .file-input label {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 500;
        }
        
        .file-input label:hover {
            transform: translateY(-2px);
        }
        
        .api-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .api-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .start-button {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 30px;
            width: 100%;
            transition: transform 0.2s;
        }
        
        .start-button:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .start-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .chat-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-container.hidden {
            display: none;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            background: rgba(249, 250, 251, 0.5);
        }
        
        .message {
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 18px;
        }
        
        .message.bot .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .message.user .message-avatar {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .message-content {
            max-width: 75%;
            padding: 20px;
            border-radius: 20px;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 15px;
        }
        
        .message.bot .message-content {
            background: white;
            color: #374151;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .input-area {
            padding: 25px;
            background: white;
            border-top: 1px solid rgba(229, 231, 235, 0.5);
            display: flex;
            gap: 15px;
        }
        
        .input-area textarea {
            flex: 1;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            resize: none;
            font-family: inherit;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .input-area textarea:focus {
            border-color: #667eea;
        }
        
        .send-button {
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: transform 0.2s;
        }
        
        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .send-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #6b7280;
        }
        
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .status.success {
            background: #dcfce7;
            color: #166534;
            border-left: 4px solid #22c55e;
        }
        
        .status.error {
            background: #fee2e2;
            color: #dc2626;
            border-left: 4px solid #ef4444;
        }
        
        .status.info {
            background: #dbeafe;
            color: #1d4ed8;
            border-left: 4px solid #3b82f6;
        }
        
        .example-queries {
            padding: 20px 25px;
            background: rgba(243, 244, 246, 0.8);
            border-bottom: 1px solid rgba(229, 231, 235, 0.5);
        }
        
        .example-queries h3 {
            font-size: 16px;
            color: #374151;
            margin-bottom: 15px;
        }
        
        .query-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
        }
        
        .query-button {
            padding: 12px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .query-button:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            transform: translateY(-1px);
        }
        
        .api-note {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            font-size: 13px;
            color: #92400e;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .setup-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .query-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span class="icon">🤖</span>
                CMHA Survey Data AI Assistant
            </h1>
            <p>Upload your survey data and interact with it using advanced AI analysis</p>
        </div>
        
        <div class="setup-section" id="setupSection">
            <h2>🚀 AI-Powered Survey Analysis</h2>
            <p>This chatbot uses Claude AI to provide sophisticated analysis of your CMHA survey data.</p>
            
            <div class="setup-grid">
                <div class="setup-item" id="dataSetup">
                    <h3>📊 Survey Data</h3>
                    <p>Upload your CMHA survey CSV file</p>
                    <div class="file-input">
                        <label for="csvFile">Choose CSV File</label>
                        <input type="file" id="csvFile" accept=".csv" />
                    </div>
                    <div id="dataStatus"></div>
                </div>
                
                <div class="setup-item" id="apiSetup">
                    <h3>🔑 API Access</h3>
                    <p>Enter your Anthropic API key for AI analysis</p>
                    <input type="password" class="api-input" id="apiKey" placeholder="sk-ant-api03-..." />
                    <div class="api-note">
                        <strong>Privacy:</strong> Your API key is stored locally and securely transmitted to our proxy server. Get your key from <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a>
                    </div>
                </div>
            </div>
            
            <button class="start-button" id="startButton" disabled>Start AI Analysis</button>
        </div>
        
        <div class="chat-container hidden" id="chatContainer">
            <div class="example-queries">
                <h3>✨ Try these AI-powered queries:</h3>
                <div class="query-buttons" id="exampleButtons">
                    <button class="query-button">What are the most important insights from this survey?</button>
                    <button class="query-button">Which factors correlate with high member satisfaction?</button>
                    <button class="query-button">What specific improvements do dissatisfied members suggest?</button>
                    <button class="query-button">How do our results compare to industry benchmarks?</button>
                    <button class="query-button">What are the top 3 actionable recommendations?</button>
                    <button class="query-button">Analyze the relationship between NPS and satisfaction</button>
                </div>
            </div>
            
            <div class="messages" id="messages"></div>
            
            <div class="input-area">
                <textarea 
                    id="messageInput" 
                    placeholder="Ask anything about your survey data... The AI can analyze patterns, provide insights, make recommendations, and answer complex questions."
                    rows="1"></textarea>
                <button class="send-button" id="sendButton">Send</button>
            </div>
        </div>
    </div>

    <script>
        let surveyData = null;
        let apiKey = null;
        let conversationHistory = [];
        
        // Detect if we're running on Netlify or locally
        const API_BASE_URL = window.location.hostname.includes('netlify.app') 
            ? `${window.location.origin}/api` 
            : 'http://localhost:8888/api';

        // File upload handling
        document.getElementById('csvFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type === 'text/csv') {
                loadCSVFile(file);
            } else {
                showDataStatus('Please select a valid CSV file.', 'error');
            }
        });

        // API key handling
        document.getElementById('apiKey').addEventListener('input', function() {
            const key = this.value.trim();
            if (key.startsWith('sk-ant-') && key.length > 20) {
                apiKey = key;
                document.getElementById('apiSetup').classList.add('completed');
            } else {
                apiKey = null;
                document.getElementById('apiSetup').classList.remove('completed');
            }
            updateStartButton();
        });

        // Start button handling
        document.getElementById('startButton').addEventListener('click', function() {
            if (surveyData && apiKey) {
                document.getElementById('setupSection').classList.add('hidden');
                document.getElementById('chatContainer').classList.remove('hidden');
                initializeChat();
            }
        });

        function showDataStatus(message, type = 'info') {
            const status = document.getElementById('dataStatus');
            status.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function updateStartButton() {
            const button = document.getElementById('startButton');
            button.disabled = !(surveyData && apiKey);
            
            if (surveyData && apiKey) {
                button.textContent = 'Start AI Analysis';
            } else if (!surveyData && !apiKey) {
                button.textContent = 'Upload CSV and Enter API Key';
            } else if (!surveyData) {
                button.textContent = 'Upload CSV File First';
            } else {
                button.textContent = 'Enter API Key First';
            }
        }

        function loadCSVFile(file) {
            showDataStatus('Loading and parsing CSV file...', 'info');
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        showDataStatus('Error parsing CSV: ' + results.errors[0].message, 'error');
                        return;
                    }
                    
                    surveyData = {
                        data: results.data,
                        headers: results.meta.fields,
                        filename: file.name
                    };
                    
                    showDataStatus(`✓ Successfully loaded ${results.data.length} survey responses!`, 'success');
                    document.getElementById('dataSetup').classList.add('completed');
                    updateStartButton();
                },
                error: function(error) {
                    showDataStatus('Error loading file: ' + error.message, 'error');
                }
            });
        }

        function initializeChat() {
            const welcomeMessage = `🎉 Welcome to your AI-powered CMHA Survey Assistant!

I've successfully loaded your survey data with ${surveyData.data.length} responses from ${surveyData.headers.length} questions. I'm now powered by Claude AI and can help you:

🔍 **Discover Hidden Insights**: Find patterns, correlations, and trends you might miss
📊 **Deep Data Analysis**: Statistical breakdowns, cross-tabulations, and comparative analysis  
💡 **Strategic Recommendations**: Actionable suggestions based on member feedback
🎯 **Custom Analysis**: Ask anything - I understand context and provide nuanced insights

Unlike simple analytics tools, I can understand complex questions, make inferences, and provide strategic business recommendations tailored to your organization.

What would you like to explore first? Try asking something like "What are the most important insights from this survey?" or click one of the example queries above!`;
            
            addMessage('bot', welcomeMessage);
        }

        // Example button handling
        document.getElementById('exampleButtons').addEventListener('click', function(event) {
            if (event.target.classList.contains('query-button')) {
                document.getElementById('messageInput').value = event.target.textContent;
                sendMessage();
            }
        });

        // Message handling
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !surveyData || !apiKey) return;
            
            input.value = '';
            addMessage('user', message);
            
            // Add to conversation history
            conversationHistory.push({ role: 'user', content: message });
            
            // Show loading
            addMessage('bot', '', true);
            
            try {
                const response = await callClaudeAPI(message);
                replaceLastMessage(response);
                conversationHistory.push({ role: 'assistant', content: response });
            } catch (error) {
                console.error('Error calling Claude API:', error);
                replaceLastMessage('Sorry, I encountered an error processing your request. Please check your connection and try again. Error: ' + error.message);
            }
        }

        async function callClaudeAPI(userMessage) {
            // Create the system prompt with survey context
            const systemPrompt = `You are an expert data analyst specializing in member satisfaction surveys. You have access to CMHA (Concrete Masonry and Hardscape Association) survey data with ${surveyData.data.length} responses.

**Your Role:**
Analyze this survey data to provide insights, identify patterns, calculate statistics, and make strategic recommendations. You can:
- Perform statistical analysis and cross-tabulations
- Identify correlations and trends
- Segment analysis by membership type  
- Calculate satisfaction metrics and NPS
- Extract and analyze open-ended feedback
- Provide strategic business recommendations
- Compare against industry standards when relevant

Always provide specific, actionable insights backed by the data. Use percentages, counts, and clear explanations. When you identify patterns or correlations, explain their business implications.

**Survey Data:**
${JSON.stringify(surveyData.data.slice(0, 50), null, 2)}

${surveyData.data.length > 50 ? `... (showing first 50 of ${surveyData.data.length} total responses)` : ''}`;

            // Prepare messages for the API call
            const messages = [
                { role: 'user', content: systemPrompt },
                ...conversationHistory.slice(-10), // Keep last 10 exchanges for context
                { role: 'user', content: userMessage }
            ];

            // Call our proxy endpoint
            const response = await fetch(`${API_BASE_URL}/claude-proxy`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    messages: messages,
                    apiKey: apiKey,
                    maxTokens: 4000
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Server error: ${response.status}`);
            }

            const data = await response.json();
            return data.content[0].text;
        }

        function addMessage(sender, content, isLoading = false) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = sender === 'bot' ? '🤖' : '👤';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            if (isLoading) {
                messageContent.innerHTML = '<div class="loading"><div class="spinner"></div> AI is analyzing your survey data...</div>';
            } else {
                messageContent.textContent = content;
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function replaceLastMessage(content) {
            const messages = document.getElementById('messages');
            const lastMessage = messages.lastElementChild;
            if (lastMessage) {
                const messageContent = lastMessage.querySelector('.message-content');
                messageContent.textContent = content;
            }
        }

        // Auto-resize textarea
        document.getElementById('messageInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    </script>
</body>
</html>